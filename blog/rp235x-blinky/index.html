<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=UTF-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1,user-scalable=no" name=viewport><meta content="index, follow" name=robots><title>Blink an LED using rp235x-pac crate</title><meta content="Blink an LED using rp235x-pac crate" name=title><meta content=Karthik name=author><meta content="Personal Commentary" name=description><meta content=website property=og:type><meta content=https://Karthik-d-k.github.io/blog/rp235x-blinky/ property=og:url><meta content=0x646b property=og:site_name><meta content="Blink an LED using rp235x-pac crate" property=og:title><meta content="Personal Commentary" property=og:description><meta content=https://Karthik-d-k.github.io/favicon.ico property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://Karthik-d-k.github.io/blog/rp235x-blinky/ property=twitter:url><meta content="Blink an LED using rp235x-pac crate" property=twitter:title><meta content="Personal Commentary" property=twitter:description><meta content=https://Karthik-d-k.github.io/favicon.ico property=twitter:image><link href=https://Karthik-d-k.github.io/blog/rp235x-blinky/ rel=canonical><link rel="shortcut icon" href=https://Karthik-d-k.github.io/favicon.ico type=image/x-icon><link href=https://Karthik-d-k.github.io/atom.xml rel=alternate title=RSS type=application/atom+xml><link href=https://speyll.github.io/suCSS/reset-min.css rel=stylesheet><link href=https://speyll.github.io/suCSS/suCSS-min.css rel=stylesheet><link href=https://Karthik-d-k.github.io/css/style.css rel=stylesheet><script defer src=https://Karthik-d-k.github.io/js/script.js></script><body><header><nav id=nav-bar><a href=/> /home </a><a href=/blog> /blog </a><a href=/til> /til </a><a href=/projects> /projects </a><a href=/tags> /tags </a><a href=/bookmarks> /bookmarks </a><a href=/cv> /cv </a><a href=# id=search-trigger> üîé </a><div><input id=theme-toggle style=display:none type=checkbox><label for=theme-toggle id=theme-toggle-label><svg class=icons id=theme-icon><use href=https://Karthik-d-k.github.io/icons.svg#lightMode></use></svg></label><audio id=theme-sound><source src=https://Karthik-d-k.github.io/click.ogg type=audio/ogg></audio></div></nav></header><main><h1>Blink an LED using rp235x-pac crate</h1><h2 id=motivation>Motivation</h2><p>I have been experimenting with <code>Hubris</code> OS to port to <code>riscv</code> ISA. I currently have access to <code>Pico 2 w</code> Board for development and testing. Hubris is a real time operating system designed for embedded devices and it has a very unique trait wherein that hardware that it runs on should have <strong>Physical memory protection unit</strong>, not necessarily <strong>Memory management unit</strong> and each and every task the OS spawns must be allocated its own memory region and memory protected. This trait helps in isolating tasks and preventing them from interfering with each other‚Äôs memory. So theoretically speaking, we could compile different tasks seperately and link them together to form a complete system image. This direction has already been prototyped by <code>exhubris</code>. I have successfully implemented <code>idle</code> and <code>supervisor</code> tasks which are absolutely necessary for an Hubris built application. But for me to actually get a visual feedback that this final image works, I need to implement a <code>blinky</code> task that will toggle the LED on and off. For more information checkout my ongoing prototype in forked repo‚Äôs <a href=https://github.com/Karthik-d-k/hubris-riscv-hazard3/tree/riscv rel=noopener target=_blank><strong>Hubris</strong></a> and <a href=https://github.com/Karthik-d-k/exhubris-riscv-hazard3/tree/riscv rel=noopener target=_blank><strong>exhubris</strong></a>.<p>There‚Äôs actually a blocker as to use <code>HAL</code> (Hardware Abstraction Layer) in this context. Since Hubris requires strict memory protection and isolation between tasks, using a traditional HAL could lead to potential violations of these principles. For this reason, Hubris pre-built application demos actually use <code>PAC</code> (Peripheral Access Crate) to interact with hardware in a way that is compatible with its memory protection model. You can checkout this <a href=https://github.com/rust-embedded/cortex-m/issues/239 rel=noopener target=_blank><strong>issue</strong></a> for additional context.<p>I have researched online about using <code>rp235x-pac</code> crate to control the GPIO pins on the Pico 2 W board and toggle the LED. But i didn‚Äôt find any examples or documentation specifically addressing this use case. And more importantly i could not use inbuilt LED to blink as is connected to wifi chip present in pico 2 w board, this is not the case in pico 2 board. Hence, I‚Äôm toggling an external LED connected to one of the GPIO pins.<h2 id=problem-statement>Problem Statement</h2><p>To blink an LED connected to one of the GPIO pins on Pico 2 (w) board. We are not allowed to use HAL crate, so we need to use PAC directly to manipulate the GPIO registers.<h2 id=implementation-details>Implementation Details</h2><p>I tried to use RP2350 Datasheet and rp235x-pac to implement on my own and found out that it‚Äôs pretty hard. Hence i went down the path of reverse engineering the HAL crate and how it interacts with the PAC to control the GPIO pins. This implementation is basically my reverse-engineered version of the HAL crate, tailored to work within the constraints of Hubris OS. From this point onward you could forget everything about Hubris OS and only concentrate on how to use <code>rp235x-pac</code> crate to control the GPIO pins. Because the underlying principles of using PAC for direct hardware access remain the same regardless of the OS constraints.<h3 id=image-metadata>Image Metadata</h3><p>As per <a href=https://datasheets.raspberrypi.org/rp2350/rp2350-datasheet.pdf rel=noopener target=_blank><strong>RP2350 Datasheet</strong></a> <em>Section:5.9.5. Minimum Viable Image Metadata</em><pre style=color:#c0c5ce;background-color:#2b303b><code><span>A minimum amount of metadata (i.e. a valid `IMAGE_DEF` block) must be embedded in
</span><span>any binary for the bootrom to recognise it as a valid program image, as opposed to,
</span><span>for example, blank flash contents or a disconnected flash device. This must appear
</span><span>within the first 4 kB of a flash image, or anywhere in a RAM or OTP image.
</span></code></pre><p>As per the datasheet, we know we have to create the following Image Metadata for riscv cores ‚Äì><pre class=language-rs data-lang=rs style=color:#c0c5ce;background-color:#2b303b><code class=language-rs data-lang=rs><span style=color:#65737e>/// A Block as understood by the Boot ROM.
</span><span style=color:#65737e>///
</span><span style=color:#65737e>/// This is an Image Definition Block
</span><span style=color:#65737e>/// It contains within the special start and end markers
</span><span style=color:#65737e>///  the Boot ROM is looking for.
</span><span>#[</span><span style=color:#bf616a>derive</span><span>(Debug)]
</span><span>#[</span><span style=color:#bf616a>repr</span><span>(C)]
</span><span style=color:#b48ead>pub struct </span><span>ImageDefBlock {
</span><span>    </span><span style=color:#bf616a>marker_start</span><span>: </span><span style=color:#b48ead>u32</span><span>,
</span><span>    </span><span style=color:#bf616a>item</span><span>: </span><span style=color:#b48ead>u32</span><span>,
</span><span>    </span><span style=color:#bf616a>length</span><span>: </span><span style=color:#b48ead>u32</span><span>,
</span><span>    </span><span style=color:#bf616a>offset</span><span>: </span><span style=color:#b48ead>u32</span><span>,
</span><span>    </span><span style=color:#bf616a>marker_end</span><span>: </span><span style=color:#b48ead>u32</span><span>,
</span><span>}
</span></code></pre><pre class=language-rs data-lang=rs style=color:#c0c5ce;background-color:#2b303b><code class=language-rs data-lang=rs><span style=color:#65737e>/// Tell the Boot ROM about our application
</span><span style=color:#65737e>/// Refer RP2350 Datasheet, Section: 5.9.5.2. Minimum RISC-V IMAGE_DEF
</span><span>#[</span><span style=color:#bf616a>link_section </span><span>= "</span><span style=color:#a3be8c>.start_block</span><span>"]
</span><span>#[</span><span style=color:#bf616a>used</span><span>]
</span><span style=color:#b48ead>pub static </span><span style=color:#d08770>IMAGE_DEF</span><span>: ImageDefBlock = ImageDefBlock {
</span><span>    marker_start: </span><span style=color:#d08770>0xffffded3</span><span>,
</span><span>    item: </span><span style=color:#d08770>0x11010142</span><span>,
</span><span>    length: </span><span style=color:#d08770>0x000001ff</span><span>,
</span><span>    offset: </span><span style=color:#d08770>0x00000000</span><span>,
</span><span>    marker_end: </span><span style=color:#d08770>0xab123579</span><span>,
</span><span>};
</span></code></pre><blockquote><p><strong>link_section = ‚Äú.start_block‚Äù</strong> is used to place the <code>IMAGE_DEF</code> block in a specific section of the binary, ensuring it is located within the first 4 kB of a flash image.</blockquote><h3 id=gpio-setup>GPIO Setup</h3><p>To setup GPIO on rp235x, we need access to 3 peripherals: <strong>SIO</strong>, <strong>IO_BANK0</strong>, and <strong>PADS_BANK0</strong>.<ul><li><strong>SIO</strong>: Single-cycle I/O for fast GPIO operations<li><strong>IO_BANK0</strong>: GPIO function selection and control<li><strong>PADS_BANK0</strong>: Electrical characteristics and pad isolation</ul><p>Get an instance of this peripherals by using the <code>rp235x-pac</code> crate.<pre class=language-rs data-lang=rs style=color:#c0c5ce;background-color:#2b303b><code class=language-rs data-lang=rs><span style=color:#b48ead>use </span><span>rp235x_pac::{</span><span style=color:#d08770>IO_BANK0</span><span>, </span><span style=color:#d08770>PADS_BANK0</span><span>, </span><span style=color:#d08770>SIO</span><span>};
</span><span>
</span><span style=color:#b48ead>let</span><span> sio: </span><span style=color:#d08770>SIO </span><span>= </span><span style=color:#b48ead>unsafe </span><span>{ </span><span style=color:#d08770>SIO</span><span>::steal() };
</span><span style=color:#b48ead>let</span><span> io_bank0 = </span><span style=color:#b48ead>unsafe </span><span>{ </span><span style=color:#d08770>IO_BANK0</span><span>::steal() };
</span><span style=color:#b48ead>let</span><span> pads_bank0 = </span><span style=color:#b48ead>unsafe </span><span>{ </span><span style=color:#d08770>PADS_BANK0</span><span>::steal() };
</span></code></pre><p>Now for example we could consider any GPIO pin to connect external LED for testing, i used <strong>GPIO22</strong>. we need to setup this pin as <strong>OUTPUT</strong>.<pre class=language-rs data-lang=rs style=color:#c0c5ce;background-color:#2b303b><code class=language-rs data-lang=rs><span style=color:#b48ead>const </span><span style=color:#d08770>LED_PIN</span><span>: </span><span style=color:#b48ead>usize </span><span>= </span><span style=color:#d08770>22</span><span>;
</span><span>
</span><span style=color:#b48ead>let</span><span> mask = </span><span style=color:#d08770>1</span><span style=color:#b48ead>u32 </span><span>&lt;&lt; </span><span style=color:#d08770>LED_PIN </span><span>as </span><span style=color:#b48ead>u32</span><span>;
</span><span>
</span><span style=color:#65737e>// Set GPIO as output
</span><span>sio.</span><span style=color:#96b5b4>gpio_oe_set</span><span>().</span><span style=color:#96b5b4>write</span><span>(|</span><span style=color:#bf616a>w</span><span>| </span><span style=color:#b48ead>unsafe </span><span>{ w.</span><span style=color:#96b5b4>bits</span><span>(mask) });
</span></code></pre><p>And then we need to configure the <strong>PADS</strong> such that input enable on, output disable is off and remove pad isolation to attach a function to this GPIO.<pre class=language-rs data-lang=rs style=color:#c0c5ce;background-color:#2b303b><code class=language-rs data-lang=rs><span style=color:#65737e>// Configure pad settings
</span><span>pads_bank0.</span><span style=color:#96b5b4>gpio</span><span>(</span><span style=color:#d08770>LED_PIN</span><span>).</span><span style=color:#96b5b4>modify</span><span>(|_, </span><span style=color:#bf616a>w</span><span>| {
</span><span>    </span><span style=color:#65737e>// Set input enable on, output disable off
</span><span>    </span><span style=color:#65737e>// RP2350: input enable defaults to off, so this is important!
</span><span>    w.</span><span style=color:#96b5b4>ie</span><span>().</span><span style=color:#96b5b4>set_bit</span><span>();
</span><span>    w.</span><span style=color:#96b5b4>od</span><span>().</span><span style=color:#96b5b4>clear_bit</span><span>();
</span><span>    </span><span style=color:#65737e>// RP2350: remove pad isolation now a function is wired up
</span><span>    w.</span><span style=color:#96b5b4>iso</span><span>().</span><span style=color:#96b5b4>clear_bit</span><span>();
</span><span>    w
</span><span>});
</span></code></pre><p>And then we set the GPIO function to <strong>SIO</strong> (Single-cycle IO subsystem) using which we write to the GPIO.<pre class=language-rs data-lang=rs style=color:#c0c5ce;background-color:#2b303b><code class=language-rs data-lang=rs><span style=color:#b48ead>use </span><span>rp235x_pac::io_bank0::gpio::gpio_ctrl::</span><span style=color:#d08770>FUNCSEL_A</span><span>;
</span><span>
</span><span style=color:#65737e>// Zero all fields apart from fsel; we want this IO to do what the peripheral tells it.
</span><span style=color:#65737e>// This doesn't affect e.g. pullup/pulldown, as these are in pad controls.
</span><span style=color:#b48ead>unsafe </span><span>{
</span><span>    io_bank0
</span><span>        .</span><span style=color:#96b5b4>gpio</span><span>(</span><span style=color:#d08770>LED_PIN</span><span>)
</span><span>        .</span><span style=color:#96b5b4>gpio_ctrl</span><span>()
</span><span>        .</span><span style=color:#96b5b4>write_with_zero</span><span>(|</span><span style=color:#bf616a>w</span><span>| w.</span><span style=color:#96b5b4>funcsel</span><span>().</span><span style=color:#96b5b4>variant</span><span>(</span><span style=color:#d08770>FUNCSEL_A</span><span>::</span><span style=color:#d08770>SIO</span><span>))
</span><span>};
</span></code></pre><p>Finally we could use the SIO to toggle the LED state.<pre class=language-rs data-lang=rs style=color:#c0c5ce;background-color:#2b303b><code class=language-rs data-lang=rs><span style=color:#65737e>// To Turn on LED
</span><span>sio.</span><span style=color:#96b5b4>gpio_out_set</span><span>().</span><span style=color:#96b5b4>write</span><span>(|</span><span style=color:#bf616a>w</span><span>| </span><span style=color:#b48ead>unsafe </span><span>{ w.</span><span style=color:#96b5b4>bits</span><span>(mask) });
</span><span style=color:#65737e>// To Turn off LED
</span><span>sio.</span><span style=color:#96b5b4>gpio_out_clr</span><span>().</span><span style=color:#96b5b4>write</span><span>(|</span><span style=color:#bf616a>w</span><span>| </span><span style=color:#b48ead>unsafe </span><span>{ w.</span><span style=color:#96b5b4>bits</span><span>(mask) });
</span></code></pre><p>This is the minimum code that is required to control GPIO by using the PAC instead of depending on the HAL.<h3 id=running-on-pico-2-w-board>Running on Pico 2(w) board</h3><p>To run the code, you could checkout my <code>rp-hal</code> crate and run the <code>blinky</code> example as follows ‚Äì><pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>git</span><span> clone https://github.com/Karthik-d-k/rp-hal.git</span><span style=color:#bf616a> -b</span><span> riscv
</span><span>
</span><span style=color:#96b5b4>cd</span><span> rp-hal/rp235x-hal-examples
</span><span>
</span><span style=color:#bf616a>cargo</span><span> rrr-blinky
</span></code></pre><blockquote><p><strong>cargo rrr-blinky</strong> will compile and flash the code successfully and run the code using <code>picotool</code>. Be sure to checkout the <a href=https://github.com/Karthik-d-k/rp-hal/blob/riscv/README.md rel=noopener target=_blank>documentation</a> on how to set-up the required tools to flash and run.</blockquote><h2 id=conclusion>Conclusion</h2><ul><li><p>Full script is available on github <a href=https://github.com/Karthik-d-k/rp-hal/blob/main/rp235x-hal-examples/src/bin/blinky.rs rel=noopener target=_blank><strong>rp-hal-blinky</strong></a></p><li><p>If you are looking for hubris task which is almost similar to the rp-hal example, you could checkout the same in <a href=https://github.com/Karthik-d-k/exhubris-riscv-hazard3/blob/riscv/task/blinky/src/main.rs rel=noopener target=_blank><strong>exhubris-blinky</strong></a></p><li><p>If you are interested in exploring the exact differences as to which PAC code compares to HAL code, you could look into the <a href=https://github.com/rp-rs/rp-hal/commit/96988070c380f720672f6243f35bbc272a57fd17 rel=noopener target=_blank><strong>github-commit</strong></a></p></ul><h2 id=references>References</h2><ul><li><p><a href=https://datasheets.raspberrypi.org/rp2350/rp2350-datasheet.pdf rel=noopener target=_blank>RP2350 Datasheet</a></p><li><p><a href=https://cliffle.com/tags/hubris/ rel=noopener target=_blank>Cliffle‚Äôs Hubris Blog posts</a></p><li><p><a href=https://hubris.oxide.computer/reference/ rel=noopener target=_blank>Hubris Reference</a></p><li><p><a href=https://github.com/Karthik-d-k/hubris-riscv-hazard3/tree/riscv rel=noopener target=_blank>Hubris-fork</a></p><li><p><a href=https://github.com/Karthik-d-k/exhubris-riscv-hazard3/tree/riscv rel=noopener target=_blank>exhubris-fork</a></p></ul><p class=tags-data><a href=/tags/rp235x>/rp235x/</a> <a href=/tags/rust>/rust/</a> <a href=/tags/blinky>/blinky/</a> <a href=/tags/hubris>/hubris/</a></main><footer><hr><footer id=footer><div id=contact-icons><a rel="noopener noreferrer" title="Subscribe via RSS for updates." class=no-style href=atom.xml target=_blank> <span class=iconify data-icon=solar:atom-bold></span> </a><a class=no-style href=mailto:karthikdk1998@gmail.com target=_blank title=Email> <span class=iconify data-icon=mdi:email></span> </a><a rel="noopener noreferrer" class=no-style href=https://github.com/Karthik-d-k target=_blank title=GitHub> <span class=iconify data-icon=mdi:github></span> </a><a rel="noopener noreferrer" class=no-style href=https://x.com/Karthik_d_k target=_blank title=Twitter> <span class=iconify data-icon=mdi:twitter></span> </a><a rel="noopener noreferrer" class=no-style href=https://www.linkedin.com/in/karthik-d-k-319853166 target=_blank title=LinkedIn> <span class=iconify data-icon=mdi:linkedin></span> </a></div><script src=https://code.iconify.design/2/2.2.1/iconify.min.js></script></footer></footer><div aria-hidden=true class=search-modal id=search-modal><div class=search-modal-backdrop></div><div class=search-modal-container><div class=search-modal-header><input enterkeyhint=search id=search-modal-input inputmode=search placeholder=Search... type=search><kbd class=search-modal-kbd>Ctrl+K</kbd></div><ul class=search-modal-results id=search-modal-results></ul><div class=search-modal-empty id=search-modal-empty style=display:none>No results found</div></div></div><script src=https://Karthik-d-k.github.io/elasticlunr.min.js></script><script>window.SEARCH_INDEX_URL = "https://Karthik-d-k.github.io/search_index.en.json";
          window.DEFAULT_THEME = "dark";</script>